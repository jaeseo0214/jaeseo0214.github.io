{% comment %} 
===================================================================================
1. 카테고리 페이지 조건 확인 (Tag 페이지 노출 방지)
===================================================================================
{% endcomment %}
{% if page.layout contains 'category' or page.url contains 'categories' %} 

{% assign entries_layout = page.entries_layout | default: 'list' %}

<div class="taxonomy-tree">
  
  {% comment %} 1. 상위 카테고리 (categories[0]) 이름 목록을 안전하게 생성 {% endcomment %}
  {% assign primary_categories_list = "" | split: "," %}
  {% for post in site.posts %}
    {% comment %} post.categories 배열의 첫 번째 요소 (상위 카테고리)를 변수에 저장 {% endcomment %}
    {% assign primary_cat = post.categories | first %}
    
    {% if primary_cat and primary_cat != "" %}
      {% assign primary_categories_list = primary_categories_list | push: primary_cat %}
    {% endif %}
  {% endfor %}
  {% assign primary_categories = primary_categories_list | uniq | sort %}

  {% for primary_cat_name in primary_categories %}
    
    {% comment %} 2. 현재 상위 카테고리에 속하는 포스트 및 하위 카테고리 이름을 모읍니다. {% endcomment %}
    {% assign primary_cat_posts = "" | split: "," %}
    {% assign subcategory_names = "" | split: "," %}
    
    {% for post in site.posts %}
      {% assign post_primary_cat = post.categories | first %}
      
      {% comment %} post의 상위 카테고리가 현재 primary_cat_name과 일치하는 포스트만 선택 {% endcomment %}
      {% if post_primary_cat == primary_cat_name %}
        {% assign primary_cat_posts = primary_cat_posts | push: post %}
        
        {% comment %} 하위 카테고리 이름 (categories | last)도 수집 {% endcomment %}
        {% assign sub_name = post.categories | last %}
        {% assign subcategory_names = subcategory_names | push: sub_name %}
      {% endif %}
    {% endfor %}
    
    {% assign unique_subcategories = subcategory_names | uniq | sort %}

    <details class="category-group">
      <summary>
        <i class="fas fa-folder"></i>
        <strong>{{ primary_cat_name }}</strong>
        <span class="taxonomy__count">{{ primary_cat_posts | size }} posts</span>
      </summary>

      {% comment %} 3. 고유한 하위 카테고리 이름 목록을 순회하며 그룹 생성 {% endcomment %}
      {% for sub_name in unique_subcategories %}
        
        {% comment %} 4. 해당 하위 카테고리(sub_name)에 속하는 포스트만 필터링 {% endcomment %}
        {% assign sub_items = "" | split: "," %}
        {% for post in primary_cat_posts %}
            {% assign post_sub_cat = post.categories | last %}
            
            {% if post_sub_cat == sub_name %}
                {% assign sub_items = sub_items | push: post %}
            {% endif %}
        {% endfor %}
        
        {% comment %} 5. 하위 카테고리 이름이 상위 카테고리 이름과 다르다면 하위 폴더로 표시 {% endcomment %}
        {% if sub_name != primary_cat_name %}
          <details class="subcategory-group">
            <summary>
              <i class="fas fa-folder-open"></i>
              {{ sub_name }}
              <span class="taxonomy__count">{{ sub_items | size }} posts</span>
            </summary>

            <ul class="post-list">
              {% for post in sub_items %}
                <li>
                  <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
                </li>
              {% endfor %}
            </ul>
          </details>
        {% else %}
          {% comment %} 단일 카테고리 포스트 (예: GITHUB) 목록을 바로 표시 {% endcomment %}
          <ul class="post-list">
            {% for post in sub_items %}
              <li>
                <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endfor %}
    </details>
  {% endfor %}
</div>

{% comment %} 
===================================================================================
2. 상위 if 태그 닫기 (카테고리 섹션 종료)
===================================================================================
{% endcomment %}
{% endif %}


{% comment %}
===================================================================================
3. 태그 페이지 조건 추가 (tag-archive.md / layout: tags)
===================================================================================
{% endcomment %}
{% if page.layout contains 'tag' or page.url contains 'tags' %}

<div class="tag-grid">
  {% assign sorted_tags = site.tags | sort %}
  {% for tag in sorted_tags %}
    {% assign tag_name = tag[0] %}
    {% assign posts = tag[1] %}
    <a class="tag-item" href="{{ '/tags/#' | append: tag_name | relative_url }}">
      <span>{{ tag_name }}</span>
      <span>{{ posts | size }}</span>
    </a>
  {% endfor %}
</div>


{% endif %}